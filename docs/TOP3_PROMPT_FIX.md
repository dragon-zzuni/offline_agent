# Top3 LLM 프롬프트 수정 (마감일 조건 우선순위 문제 해결)

## 문제 상황

사용자가 "마감이 많이 남은 것을 우선적으로 선정해주세요"라고 **마감일 조건만** 요청했는데도, D-20인 TODO가 선정되지 않고 D-1, D-0 같은 임박한 TODO가 선정되는 문제가 발생했습니다.

### 원인 분석

#### 1. LLM 프롬프트 문제
기존 프롬프트의 선정 기준 5번:
```
5. **위 1, 2, 3, 4 조건을 모두 만족하는 TODO 중에서** 마감일, 우선순위 등을 고려하여 3개 선정
```

이 문장이 LLM에게 "프로젝트/요청자/유형/수신방법 조건(1~4번)을 **먼저 모두 만족**시킨 후에 마감일을 고려하라"고 지시하고 있었습니다.

**문제점:**
- 사용자가 "마감이 많이 남은 것만" 요청 (프로젝트/요청자/유형 조건 없음)
- 하지만 프롬프트는 "1~4번 조건을 먼저 체크하라"고 강제
- LLM이 조건이 없는데도 1~4번을 먼저 고려하려고 시도
- 마감일 조건이 후순위로 밀림

#### 2. 폴백 모드 문제
`_fallback_selection` 메서드는 자연어 규칙을 전혀 고려하지 않고, 하드코딩된 점수 계산만 사용:

```python
# 마감일 임박도
if hours_left < 24:
    score += 2.0
elif hours_left < 72:
    score += 1.0
```

**문제점:**
- 마감일이 **가까울수록** 점수가 높아짐 (24시간 이내 +2점, 72시간 이내 +1점)
- 72시간(3일) 이상 남은 TODO는 마감일 점수가 **0점**
- "마감이 많이 남은 것"이라는 규칙과 정반대로 동작

## 해결 방법

### LLM 프롬프트 수정

#### 변경 전
```
선정 기준 (반드시 순서대로 적용):
1. **프로젝트 조건을 최우선으로 정확히 만족**
2. **요청자 조건을 정확히 만족**
3. **유형 조건을 절대적으로 만족**
4. **수신방법 조건을 정확히 만족**
5. **위 1, 2, 3, 4 조건을 모두 만족하는 TODO 중에서** 마감일, 우선순위 등을 고려
```

#### 변경 후
```
선정 기준 (사용자가 명시한 조건만 적용):
**중요**: 사용자 규칙에 명시되지 않은 조건은 무시하세요! 
예를 들어 "마감이 많이 남은 것"만 요청했다면 프로젝트/요청자/유형은 고려하지 마세요.

1. **프로젝트 조건 (사용자가 프로젝트를 명시한 경우에만 적용)**
2. **요청자 조건 (사용자가 요청자를 명시한 경우에만 적용)**
3. **유형 조건 (사용자가 유형을 명시한 경우에만 적용)**
4. **수신방법 조건 (사용자가 수신방법을 명시한 경우에만 적용)**
5. **마감일 조건 (사용자가 마감일 관련 조건을 명시한 경우 최우선 적용)**:
   - "마감이 많이 남은", "여유있는", "급하지 않은" → 마감일이 가장 먼 TODO 우선
   - "마감이 임박한", "긴급한", "급한" → 마감일이 가장 가까운 TODO 우선
   - 마감일 조건이 명시되었다면 이를 **최우선**으로 고려하세요!
6. **우선순위 조건 (사용자가 우선순위를 명시한 경우에만 적용)**
7. **최종 선정**: 위에서 사용자가 명시한 조건들을 모두 만족하는 TODO 중에서 3개 선정
```

### 주요 개선사항

1. **조건부 적용 명시**: 각 조건에 "(사용자가 X를 명시한 경우에만 적용)" 추가
2. **마감일 조건 명시적 추가**: 5번 항목으로 마감일 조건을 명시적으로 추가
3. **마감일 방향성 구분**: "많이 남은" vs "임박한"을 명확히 구분
4. **최우선 적용 강조**: 마감일 조건이 명시되면 최우선으로 고려하도록 명시
5. **맨 위에 강조 문구**: "사용자 규칙에 명시되지 않은 조건은 무시하세요!"

## 테스트 결과

### 테스트 케이스: 마감일 조건만 명시
```python
natural_rule = "마감이 많이 남은 것을 우선적으로 선정해주세요"

todos = [
    {"id": "todo_1", "deadline": D-1, "priority": "high"},
    {"id": "todo_2", "deadline": D-5, "priority": "medium"},
    {"id": "todo_3", "deadline": D-20, "priority": "low"},
    {"id": "todo_4", "deadline": D-10, "priority": "medium"},
    {"id": "todo_5", "deadline": D-0, "priority": "high"}
]
```

#### 기대 결과
- 1위: todo_3 (D-20)
- 2위: todo_4 (D-10)
- 3위: todo_2 (D-5)

#### 실제 결과 (수정 전)
- 폴백 모드: todo_5 (D-0), todo_1 (D-1), todo_2 (D-5)
- 이유: 우선순위 점수만으로 선정 (high=3, medium=2, low=1)

#### 실제 결과 (수정 후)
- LLM 모드: 마감일이 먼 순서대로 선정 (기대 결과와 일치)
- 폴백 모드: 여전히 문제 있음 (자연어 규칙 미반영)

## 향후 개선 사항

### 폴백 모드 개선 필요
현재 폴백 모드는 자연어 규칙을 전혀 고려하지 않습니다. 다음과 같은 개선이 필요합니다:

1. **간단한 키워드 파싱**: "마감이 많이 남은", "마감이 임박한" 등의 키워드 감지
2. **조건부 점수 계산**: 감지된 키워드에 따라 점수 계산 방식 변경
3. **우선순위 동적 조정**: 사용자가 명시한 조건을 우선순위로 반영

### 예시 코드 (폴백 모드 개선안)
```python
def _fallback_selection(self, todos: List[Dict], natural_rule: str = "") -> Set[str]:
    # 자연어 규칙에서 키워드 추출
    rule_lower = natural_rule.lower()
    
    # 마감일 방향성 감지
    deadline_far = any(kw in rule_lower for kw in ["많이 남은", "여유", "급하지 않은"])
    deadline_near = any(kw in rule_lower for kw in ["임박", "긴급", "급한"])
    
    for todo in todos:
        score = 0.0
        
        # 마감일 점수 (방향성에 따라 반대로 계산)
        deadline = todo.get("deadline")
        if deadline:
            hours_left = (datetime.fromisoformat(deadline) - now).total_seconds() / 3600.0
            
            if deadline_far:
                # 많이 남을수록 높은 점수
                if hours_left > 480:  # 20일 이상
                    score += 3.0
                elif hours_left > 240:  # 10일 이상
                    score += 2.0
                elif hours_left > 120:  # 5일 이상
                    score += 1.0
            elif deadline_near:
                # 임박할수록 높은 점수 (기존 로직)
                if hours_left < 24:
                    score += 2.0
                elif hours_left < 72:
                    score += 1.0
```

## 관련 파일

- `offline_agent/src/services/top3_llm_selector.py`: Top3 LLM 선정 로직
- `offline_agent/debug_top3_deadline_only.py`: 마감일 조건 테스트 스크립트
- `offline_agent/docs/TOP3_NATURAL_RULE_PROCESS.md`: Top3 자연어 규칙 처리 문서

## 수정 일시

2024-11-19 (수정 완료)
