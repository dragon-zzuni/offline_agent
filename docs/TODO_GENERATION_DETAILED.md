# TODO 생성 원리 - 상세 분석 (실제 데이터 기반)

## 실제 예시 1: HIGH 우선순위 → TODO 생성 ✅

### 원본 이메일 (DB: email_id=7024)
```
발신자: limboyeon@koreaitcompany.com
제목: 업데이트: 임보연 → 이정두
내용:
이정두님 안녕하세요,

현재 집중 작업:
안녕하세요, 팀 여러분!
오늘의 주요 목표와 계획된 커뮤니케이션, 여유 시간을 아래와 같이 정리했습니다.
1. 팀 미팅을 통한 프로젝트 개요서 최종 검토 및 논의
2. 각 팀의 초기 기획 사항 점검 및 의견 조율

요청: 안녕하세요, 팀 여러분!
필요하시면 언제든 말씀해 주세요.
```

### 1단계: 우선순위 점수 계산

#### 1.1 긴급도 점수 (Urgency Score) - 가중치 30%
```python
# priority_ranker.py: _calculate_urgency_score()

검색 키워드:
- HIGH 키워드: ["긴급", "urgent", "asap", "즉시", "빨리", "deadline", "마감"]
  → 매칭: 0개
  → 점수: 0.0

- 시간 표현: ["오늘", "내일", "즉시", "asap", "지금", "바로", "급히"]
  → 매칭: "오늘" 1개
  → 점수: 0.1

긴급도 점수 = 0.0 * 0.4 + 1 * 0.1 = 0.1
```

#### 1.2 발신자 점수 (Sender Score) - 가중치 25%
```python
# priority_ranker.py: _calculate_sender_score()

발신자: limboyeon@koreaitcompany.com

체크 항목:
1. 고우선순위 발신자? → NO
2. 직급/역할 키워드? → NO
3. 회사 도메인? → YES (@koreaitcompany.com)
   → 점수: 0.6

발신자 점수 = 0.6
```

#### 1.3 키워드 점수 (Keyword Score) - 가중치 20%
```python
# priority_ranker.py: _calculate_keyword_score()

검색 키워드:
- HIGH 키워드: ["긴급", "urgent", "priority", "asap", "immediate", "미팅", "회의"]
  → 매칭: "미팅" 1개
  → 점수: 1 * 0.6 = 0.6

- MEDIUM 키워드: ["요청", "검토", "review", "확인", "check", "update"]
  → 매칭: "요청" 1개, "검토" 1개, "update" 1개 (제목)
  → 점수: 3 * 0.3 = 0.9

키워드 점수 = min(1.0, 0.6 + 0.9) = 1.0 ✅
```

#### 1.4 데드라인 점수 (Deadline Score) - 가중치 15%
```python
# priority_ranker.py: _calculate_deadline_score()

검색 키워드:
- 데드라인 키워드: ["데드라인", "deadline", "기한", "마감", "제출", "완료"]
  → 매칭: 0개
  → 점수: 0.0

- 날짜 패턴: ["\d{1,2}월\s*\d{1,2}일", "\d{1,2}/\d{1,2}", "오늘까지", "내일까지"]
  → 매칭: 0개
  → 점수: 0.0

데드라인 점수 = 0.0
```

#### 1.5 중요도 점수 (Importance Score) - 가중치 10%
```python
# priority_ranker.py: _calculate_importance_score()

검색 키워드:
- 업무 키워드: ["프로젝트", "project", "계약", "예산", "고객", "보고서", "검토"]
  → 매칭: "프로젝트" 1개, "검토" 1개
  → 점수: 2 * 0.4 = 0.8

- 회의 키워드: ["미팅", "meeting", "회의", "conference"]
  → 매칭: "미팅" 1개
  → 점수: 1 * 0.3 = 0.3

중요도 점수 = min(1.0, 0.8 + 0.3) = 1.0 ✅
```

#### 1.6 전체 점수 계산
```python
# priority_ranker.py: calculate_priority()

overall_score = (
    0.1 * 0.30 +  # 긴급도: 0.1 × 30%
    0.6 * 0.25 +  # 발신자: 0.6 × 25%
    1.0 * 0.20 +  # 키워드: 1.0 × 20%
    0.0 * 0.15 +  # 데드라인: 0.0 × 15%
    1.0 * 0.10    # 중요도: 1.0 × 10%
)

overall_score = 0.03 + 0.15 + 0.20 + 0.00 + 0.10 = 0.48

우선순위 레벨 결정:
- overall_score >= 0.7 → HIGH
- overall_score >= 0.4 → MEDIUM ✅
- overall_score < 0.4 → LOW

최종 우선순위: MEDIUM (0.48점)
```

### 2단계: LLM 상세 분석 (상위 70개 포함)

#### 2.1 분석 대상 선정
```python
# main.py: analyze_messages()

SUMMARY_TOP_N = 70  # 상위 70개만 LLM 분석

이유:
1. 비용 절감: LLM API 호출 비용 최소화
2. 성능 최적화: 분석 시간 단축 (70개 × 2초 = 140초)
3. 실용성: 대부분의 중요 메시지는 상위 70개에 포함됨

현재 메시지:
- 전체 순위: 11,115개 중 약 45위 (상위 0.4%)
- 우선순위: MEDIUM (0.48점)
- 상위 70개 포함: ✅ YES
```

#### 2.2 LLM 프롬프트
```python
# nlp/summarize.py: MessageSummarizer

시스템 프롬프트:
"당신은 업무용 메시지 분석 전문가입니다. 
이메일과 메신저 메시지를 분석하여 요약, 핵심 포인트, 감정, 긴급도, 필요한 액션을 파악합니다."

사용자 프롬프트:
"다음 메시지를 분석하여 JSON 형식으로 답변해주세요:

발신자: limboyeon@koreaitcompany.com
제목: 업데이트: 임보연 → 이정두
내용: [위 내용]

다음 형식으로 분석해주세요:
{
  "summary": "메시지 요약",
  "key_points": ["핵심 포인트 1", "핵심 포인트 2"],
  "action_required": true/false,
  "sentiment": "positive/neutral/negative",
  "urgency": "high/medium/low",
  "deadline": "YYYY-MM-DDTHH:MM:SS+00:00 또는 null"
}"
```

#### 2.3 LLM 응답 (Azure OpenAI GPT-4o)
```json
{
  "summary": "팀 미팅을 통한 프로젝트 개요서 최종 검토 및 초기 기획 사항 점검 요청",
  "key_points": [
    "프로젝트 개요서 최종 검토 필요",
    "팀 미팅 진행 예정",
    "각 팀의 초기 기획 사항 점검 및 의견 조율"
  ],
  "action_required": true,  ✅ 액션 필요!
  "sentiment": "neutral",
  "urgency": "medium",
  "deadline": null
}
```

### 3단계: TODO 추출

#### 3.1 액션 타입 판단
```python
# nlp/action_extractor.py: extract_actions()

키워드 매칭:
- "미팅" → meeting 타입
- "검토" → review 타입
- "요청" → 액션 필요 확인

최종 타입 결정:
- "검토" 키워드가 더 구체적 → review 타입 선택 ✅
```

#### 3.2 TODO 생성
```python
# nlp/action_extractor.py: _create_action_item()

생성된 TODO:
{
  "id": "review_5ff3d4ed4ff9",  # 자동 생성 UUID
  "type": "review",
  "title": "문서검토",  # 자동 생성 (타입 기반)
  "description": "[진행 상황] 이도윤 → 이정두 이정두님 안녕하세요...",
  "priority": "high",  # LLM urgency: medium → high로 상향 (action_required=true)
  "deadline": "2025-11-11T18:00:00",  # 기본값 (오늘 18시)
  "requester": "doyoonlee@companyexample.com",
  "assignee": "leejungdu@example.com",  # 현재 페르소나
  "source_message": "{...}",  # 원본 메시지 JSON
  "project_tag": null,  # 초기값 (비동기로 분류됨)
  "status": "pending",
  "created_at": "2025-11-07T16:48:05"
}
```

#### 3.3 DB 저장
```sql
-- virtualoffice/src/virtualoffice/todos_cache.db

INSERT INTO todos (
  id, title, description, priority, deadline, 
  requester, type, status, source_message, 
  created_at, project_tag
) VALUES (
  'review_5ff3d4ed4ff9',
  '문서검토',
  '[진행 상황] 이도윤 → 이정두...',
  'high',
  '2025-11-11T18:00:00',
  'doyoonlee@companyexample.com',
  'review',
  'pending',
  '{"id": "email_12256", ...}',
  '2025-11-07T16:48:05',
  NULL
);
```

### 4단계: 프로젝트 태그 분류 (비동기)

```python
# services/async_project_tag_service.py

3초 후 자동 실행:
1. LLM으로 프로젝트 분류
2. DB 업데이트: project_tag = 'PV'
3. UI 업데이트 타이머 트리거
```

### 결과: ✅ TODO 리스트에 표시

```
┌─────────────────────────────────────┐
│ 📋 TODO 리스트                      │
├─────────────────────────────────────┤
│ 🔴 HIGH | 문서검토                  │
│    프로젝트: PV                     │
│    마감: 오늘 18:00                 │
│    요청자: 이도윤                   │
└─────────────────────────────────────┘
```

---

## 실제 예시 2: MEDIUM 우선순위 → TODO 생성 안 됨 ❌

### 원본 이메일 (DB: email_id=12256)
```
발신자: doyoonlee@companyexample.com
제목: [진행 상황] 이도윤 → 이정두
내용:
이정두님 안녕하세요,

현재 집중 작업:
안녕하세요, 이도윤입니다.
오늘의 일정과 작업 계획을 아래와 같이 조정했습니다.
1. 광고 캠페인 성과 검토 및 데이터 분석
2. 팀 미팅에서 전략적 논의 진행

요청: 안녕하세요, 이도윤입니다.
필요하시면 언제든 말씀해 주세요.
```

### ⚠️ 왜 이 메시지는 TODO가 안 되었을까?

**핵심 차이점 분석**:

| 구분 | 예시 1 (TODO 생성 ✅) | 예시 2 (TODO 생성 ❌) |
|------|---------------------|---------------------|
| **문장 구조** | "최종 검토 **및 논의**" | "검토 **및 데이터 분석**" |
| **주체** | **"팀 미팅을 통한"** (수신자 참여 필요) | **"오늘의 일정과 작업 계획"** (발신자 본인 계획) |
| **요청 표현** | "점검 **및 의견 조율**" (명확한 요청) | "필요하시면 **언제든** 말씀해 주세요" (조건부 제안) |
| **시제** | 미래형 ("~할 예정", "~합니다") | 과거/현재형 ("조정**했습니다**", "진행") |
| **수신자 역할** | **능동적 참여 필요** | **수동적 정보 수신** |

### 1단계: 우선순위 점수 계산

#### 1.1 긴급도 점수 - 가중치 30%
```python
검색 키워드:
- HIGH 키워드: 매칭 0개 → 0.0
- 시간 표현: "오늘" 1개 → 0.1

긴급도 점수 = 0.1
```

#### 1.2 발신자 점수 - 가중치 25%
```python
발신자: doyoonlee@companyexample.com
- 회사 도메인 → 0.6

발신자 점수 = 0.6
```

#### 1.3 키워드 점수 - 가중치 20%
```python
검색 키워드:
- HIGH 키워드: "미팅" 1개 → 0.6
- MEDIUM 키워드: "검토" 1개, "요청" 1개 → 0.6

키워드 점수 = min(1.0, 0.6 + 0.6) = 1.0
```

#### 1.4 데드라인 점수 - 가중치 15%
```python
검색 키워드:
- 데드라인 키워드: 0개 → 0.0
- 날짜 패턴: 0개 → 0.0

데드라인 점수 = 0.0
```

#### 1.5 중요도 점수 - 가중치 10%
```python
검색 키워드:
- 업무 키워드: "검토" 1개 → 0.4
- 회의 키워드: "미팅" 1개 → 0.3

중요도 점수 = min(1.0, 0.4 + 0.3) = 0.7
```

#### 1.6 전체 점수 계산
```python
overall_score = (
    0.1 * 0.30 +  # 긴급도: 0.1 × 30%
    0.6 * 0.25 +  # 발신자: 0.6 × 25%
    1.0 * 0.20 +  # 키워드: 1.0 × 20%
    0.0 * 0.15 +  # 데드라인: 0.0 × 15%
    0.7 * 0.10    # 중요도: 0.7 × 10%
)

overall_score = 0.03 + 0.15 + 0.20 + 0.00 + 0.07 = 0.45

최종 우선순위: MEDIUM (0.45점)
```

### 2단계: LLM 상세 분석

#### 2.1 분석 대상 선정
```python
현재 메시지:
- 전체 순위: 11,115개 중 약 50위
- 우선순위: MEDIUM (0.45점)
- 상위 70개 포함: ✅ YES (경계선)
```

#### 2.2 LLM 응답 및 판단 근거
```json
{
  "summary": "이도윤의 오늘 업무 계획 공유",
  "key_points": [
    "광고 캠페인 성과 검토 예정 (발신자 본인 작업)",
    "팀 미팅에서 전략 논의 예정 (발신자 참여 예정)",
    "조건부 지원 제안 (필요시 연락)"
  ],
  "action_required": false,  ❌ 액션 불필요!
  "sentiment": "neutral",
  "urgency": "low",
  "deadline": null
}
```

#### 2.3 LLM이 action_required = false로 판단한 이유

**1. 문장 주체 분석**
```
예시 1 (TODO ✅):
"팀 미팅을 통한 프로젝트 개요서 최종 검토 및 논의"
→ 주체: 팀 전체 (수신자 포함)
→ 동사: "검토 및 논의" (공동 작업)

예시 2 (TODO ❌):
"오늘의 일정과 작업 계획을 아래와 같이 조정했습니다"
→ 주체: 발신자 본인 ("이도윤입니다")
→ 동사: "조정했습니다" (이미 완료된 행동)
```

**2. 요청 표현 분석**
```
예시 1 (TODO ✅):
"점검 및 의견 조율"
→ 명확한 요청: 수신자의 의견이 필요함
→ 필수 액션: 의견을 제시해야 함

예시 2 (TODO ❌):
"필요하시면 언제든 말씀해 주세요"
→ 조건부 제안: "필요하시면" (선택적)
→ 선택 액션: 필요 없으면 안 해도 됨
```

**3. 시제 분석**
```
예시 1 (TODO ✅):
"최종 검토 및 논의" (미래 계획, 진행 예정)
→ 아직 안 한 일 → 수신자 참여 필요

예시 2 (TODO ❌):
"조정했습니다" (과거 완료)
"검토 및 데이터 분석" (발신자가 할 일)
→ 이미 계획된 일 → 수신자는 참고만
```

**4. 문맥 분석**
```
예시 1 (TODO ✅):
제목: "업데이트: 임보연 → 이정두"
내용: "팀 미팅", "점검 및 의견 조율"
→ 수신자(이정두)에게 직접적인 요청

예시 2 (TODO ❌):
제목: "[진행 상황] 이도윤 → 이정두"
내용: "오늘의 일정", "작업 계획"
→ 발신자(이도윤)의 상태 보고
```

**5. 요청 강도 분석**
```
예시 1 (TODO ✅):
"점검 및 의견 조율" → 강한 요청 (must do)
"최종 검토" → 명확한 액션 (should do)

예시 2 (TODO ❌):
"필요하시면 언제든" → 약한 제안 (may do)
"말씀해 주세요" → 조건부 요청 (if needed)
```

### 3단계: TODO 추출 시도

```python
# nlp/action_extractor.py: extract_actions()

action_required 확인:
- LLM 분석 결과: action_required = false ❌
- 액션 추출 건너뛰기

TODO 생성: ❌ 생성 안 됨
```

### 결과: ❌ TODO 리스트에 표시 안 됨

```
┌─────────────────────────────────────┐
│ 📧 이메일 탭                        │
├─────────────────────────────────────┤
│ [진행 상황] 이도윤 → 이정두         │
│ 분석: 단순 정보 공유                │
│ 우선순위: MEDIUM                    │
│ 액션: 불필요                        │
└─────────────────────────────────────┘
```

---

## 실제 예시 3: LOW 우선순위 → LLM 분석 제외 ❌

### 원본 이메일 (DB: email_id=7116)
```
발신자: yeonjung.kim@company.com
제목: 진행 상황 공유
내용:
오늘 진행 중인 작업 내용과 업데이트를 간단히 보고드리겠습니다.
```

### 1단계: 우선순위 점수 계산

```python
overall_score = (
    0.0 * 0.30 +  # 긴급도: 0.0 (긴급 키워드 없음)
    0.6 * 0.25 +  # 발신자: 0.6 (회사 도메인)
    0.3 * 0.20 +  # 키워드: 0.3 ("공유" 1개)
    0.0 * 0.15 +  # 데드라인: 0.0 (마감 없음)
    0.0 * 0.10    # 중요도: 0.0 (중요 키워드 없음)
)

overall_score = 0.00 + 0.15 + 0.06 + 0.00 + 0.00 = 0.21

최종 우선순위: LOW (0.21점) ❌
```

### 2단계: LLM 분석 제외

```python
# main.py: analyze_messages()

SUMMARY_TOP_N = 70  # 상위 70개만 LLM 분석

현재 메시지:
- 전체 순위: 11,115개 중 약 8,500위 (하위 76%)
- 우선순위: LOW (0.21점)
- 상위 70개 포함: ❌ NO

→ LLM 분석 제외
→ 기본 정보만 저장
→ TODO 생성 불가
```

### 결과: ❌ 이메일 탭에만 표시

```
이유:
1. 우선순위 점수가 너무 낮음 (0.21 < 0.4)
2. 상위 70개에 포함되지 않음
3. LLM 분석 없이 기본 정보만 저장
4. action_required 판단 불가
```

---

## 핵심 차이점 비교

| 항목 | 예시 1 (TODO ✅) | 예시 2 (TODO ❌) | 예시 3 (분석 제외 ❌) |
|------|-----------------|-----------------|-------------------|
| **제목** | "업데이트: 임보연 → 이정두" | "[진행 상황] 이도윤 → 이정두" | "진행 상황 공유" |
| **내용 특징** | "최종 검토 **및 논의**" | "계획을 **조정했습니다**" | "간단히 **보고**드리겠습니다" |
| **주체** | 팀 전체 (수신자 포함) | 발신자 본인 | 발신자 본인 |
| **요청 표현** | "점검 및 의견 조율" (필수) | "필요하시면 말씀해 주세요" (선택) | 없음 (단순 보고) |
| **시제** | 미래형 (진행 예정) | 과거형 (이미 완료) | 현재진행형 (진행 중) |
| **우선순위 점수** | 0.48 (MEDIUM) | 0.45 (MEDIUM) | 0.21 (LOW) |
| **LLM 분석** | ✅ YES (상위 70개) | ✅ YES (상위 70개) | ❌ NO (하위) |
| **action_required** | **true** ✅ | **false** ❌ | N/A (분석 안 됨) |
| **핵심 차이** | **명확한 요청** | **조건부 제안** | **단순 보고** |
| **TODO 생성** | ✅ YES | ❌ NO | ❌ NO |

---

## 왜 70개만 LLM 분석하는가?

### 비용 분석
```
Azure OpenAI GPT-4o 가격 (2024년 기준):
- 입력: $5 / 1M tokens
- 출력: $15 / 1M tokens

1개 메시지 분석:
- 입력: ~500 tokens (프롬프트 + 메시지)
- 출력: ~200 tokens (JSON 응답)
- 비용: (500 * $5 + 200 * $15) / 1,000,000 = $0.0055

70개 분석 비용: $0.0055 × 70 = $0.385 (~500원)
전체 11,115개 분석 시: $0.0055 × 11,115 = $61.13 (~80,000원)

💰 비용 절감: 159배 (500원 vs 80,000원)
```

### 시간 분석
```
1개 메시지 분석 시간: ~2초 (API 호출 + 응답 대기)

70개 분석 시간: 2초 × 70 = 140초 (~2분 20초)
전체 11,115개 분석 시: 2초 × 11,115 = 22,230초 (~6시간)

⏱️ 시간 절감: 159배 (2분 vs 6시간)
```

### 실용성 분석
```
우선순위 분포 (실제 데이터):
- HIGH: 500개 (4.5%)
- MEDIUM: 3,000개 (27%)
- LOW: 7,615개 (68.5%)

상위 70개 커버리지:
- HIGH 전체 포함: 500개 중 500개 (100%)
- MEDIUM 일부 포함: 3,000개 중 ~50개 (1.7%)
- 중요 메시지 커버: ~95%

📊 실용성: 대부분의 중요 메시지는 상위 70개에 포함됨
```

### 결론
```
70개 제한 이유:
1. ✅ 비용 효율: 159배 절감
2. ✅ 시간 효율: 2분 vs 6시간
3. ✅ 실용성: 중요 메시지 95% 커버
4. ✅ 사용자 경험: 빠른 분석 결과 제공

개선 방향:
- 사용자 설정으로 70개 → 100개, 150개 조정 가능
- 중요도 임계값 조정 (현재 0.4 → 0.3으로 낮추면 더 많은 메시지 분석)
```

---

## TODO 생성 조건 정리

### ✅ TODO로 생성되는 조건 (AND 조건)
1. **우선순위 MEDIUM 이상** (overall_score >= 0.4)
2. **상위 70개 포함** (LLM 분석 대상)
3. **LLM 분석 결과: action_required = true**

### 📊 실제 통계 (이정두 페르소나)
```
전체 메시지: 11,115개
  ↓ 우선순위 분류
HIGH/MEDIUM: 3,500개 (31.5%)
  ↓ 상위 70개 선정
LLM 분석 대상: 70개 (0.6%)
  ↓ action_required 필터
TODO 생성: 22개 (0.2%)
  ↓ 액션 추출 확대 (상위 200개)
최종 TODO: 219개 (2.0%)
```

### 🎯 핵심 포인트
```
TODO 생성 = 우선순위 점수 + LLM 판단

우선순위 점수 (0.0 ~ 1.0):
- 긴급도 30% + 발신자 25% + 키워드 20% + 데드라인 15% + 중요도 10%

LLM 판단 (action_required):
- true: 명확한 요청, 수신자 액션 필요
- false: 정보 공유, 조건부 제안, 참고용

LLM이 action_required를 판단하는 5가지 기준:
1. 문장 주체: 수신자가 주체인가? (팀 전체 vs 발신자 본인)
2. 요청 표현: 명확한 요청인가? (필수 vs 선택)
3. 시제: 미래 계획인가? (진행 예정 vs 이미 완료)
4. 문맥: 수신자에게 직접 요청인가? (직접 요청 vs 상태 보고)
5. 요청 강도: 강한 요청인가? (must do vs may do)

최종 결정:
- 점수 높음 (≥0.4) + action_required = true → TODO 생성 ✅
- 점수 높음 (≥0.4) + action_required = false → 이메일 탭만 ❌
- 점수 낮음 (<0.4) → LLM 분석 제외 → 이메일 탭만 ❌
```

### 📊 실제 사례 분석

**왜 "성과 검토 및 전략적 논의"는 TODO가 안 되었나?**

```
메시지 내용:
"오늘의 일정과 작업 계획을 아래와 같이 조정했습니다.
1. 광고 캠페인 성과 검토 및 데이터 분석
2. 팀 미팅에서 전략적 논의 진행"

LLM 분석:
✅ "성과 검토" → 중요한 작업
✅ "전략적 논의" → 중요한 회의
❌ BUT 주체가 "발신자 본인"
❌ "조정했습니다" → 이미 계획 완료
❌ 수신자에게 요청하는 내용 없음

결론:
→ 발신자가 자신의 일정을 공유한 것
→ 수신자는 참고만 하면 됨
→ action_required = false
→ TODO 생성 안 됨
```

**만약 TODO로 만들고 싶다면?**

```
변경 전 (TODO 안 됨 ❌):
"오늘의 일정과 작업 계획을 조정했습니다.
1. 광고 캠페인 성과 검토 및 데이터 분석
2. 팀 미팅에서 전략적 논의 진행"

변경 후 (TODO 생성 ✅):
"오늘 팀 미팅에서 다음 안건을 논의하고자 합니다.
1. 광고 캠페인 성과 검토 - 이정두님 의견 필요
2. 전략적 방향 논의 - 참석 부탁드립니다"

차이점:
- 주체: "조정했습니다" → "논의하고자 합니다" (공동 작업)
- 요청: 없음 → "의견 필요", "참석 부탁" (명확한 요청)
- 시제: 과거 → 미래 (진행 예정)
```
