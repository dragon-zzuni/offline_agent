# 문제 해결 가이드 (Troubleshooting)

## LLM 호출 관련 문제 (v1.1.9 신규)

### 문제: "LLM 응답 시간이 초과되었습니다 (60초)"

**증상:**
- TODO 상세 다이얼로그에서 요약 생성 또는 회신 초안 작성 시 타임아웃 오류 발생

**원인:**
- 네트워크 연결이 느림
- LLM API 서버 응답이 지연됨
- 방화벽이나 프록시가 연결을 차단함

**해결 방법:**
1. 네트워크 연결 상태 확인
2. 잠시 후 다시 시도
3. 로그에서 상세 오류 확인:
   ```
   [TodoDetail][LLM] 타임아웃 (60초 초과)
   ```
4. 방화벽 설정 확인 (Azure/OpenAI 도메인 허용)

### 문제: "LLM API 오류 (400/401/403)"

**증상:**
- HTTP 오류 코드와 함께 LLM 호출 실패

**원인:**
- API 키가 잘못되었거나 만료됨 (401)
- 잘못된 요청 파라미터 (400)
- 권한 부족 (403)

**해결 방법:**
1. `.env` 파일의 API 키 확인
2. 로그에서 상세 오류 메시지 확인:
   ```
   [TodoDetail][LLM] HTTP 오류: 400 - {"error": {"code": "InvalidRequest", ...}}
   ```
3. Azure OpenAI 사용 시:
   - API 버전 확인 (`2024-08-01-preview` 권장)
   - Deployment 이름 확인
   - Endpoint URL 확인

### 문제: "LLM 응답 파싱 실패"

**증상:**
- JSON 파싱 오류 발생

**원인:**
- LLM API가 JSON이 아닌 다른 형식으로 응답
- 응답이 손상됨

**해결 방법:**
1. 로그에서 응답 내용 확인:
   ```
   [TodoDetail][LLM] JSON 파싱 실패: Expecting value: line 1 column 1 (char 0)
   ```
2. API 키 및 설정 재확인
3. 다른 LLM 공급자로 전환 시도

### 문제: "LLM 응답이 비어있습니다"

**증상:**
- API 호출은 성공했지만 내용이 없음

**원인:**
- LLM이 빈 응답을 반환함
- API 응답 구조가 예상과 다름

**해결 방법:**
1. 로그 확인:
   ```
   [TodoDetail][LLM] choices가 비어있음
   [TodoDetail][LLM] content가 비어있음
   ```
2. 다시 시도
3. 문제가 지속되면 GitHub Issues에 로그와 함께 보고

### LLM 디버깅 팁

**로그 레벨 변경:**
```python
# main.py 또는 run_gui.py
import logging
logging.basicConfig(level=logging.DEBUG)  # 상세 로그 출력
```

**로그 출력 예시 (정상):**
```
[TodoDetail][LLM] provider=azure URL=https://krcentral.cognitiveservices.azure.com/... 요약/회신 생성 중...
[TodoDetail][LLM] 응답 수신 (status=200)
[TodoDetail][LLM] 생성 완료 (길이: 245자)
```

**로그 출력 예시 (오류):**
```
[TodoDetail][LLM] provider=azure URL=https://krcentral.cognitiveservices.azure.com/... 요약/회신 생성 중...
[TodoDetail][LLM] HTTP 오류: 400 - {"error": {"code": "InvalidRequest", "message": "max_tokens is not supported"}}
```

---

## "수집할 메시지가 없습니다" 오류

### 증상
- 메시지 수집 시작 버튼을 눌렀을 때 "수집할 메시지가 없습니다" 오류 발생
- 데이터 파일(`chat_communications.json`, `email_communications.json`)에는 메시지가 있음
- 시간 범위를 선택했는데도 메시지가 조회되지 않음

### 원인
1. **시간 범위 필터링 문제**: 선택한 시간 범위 내에 실제로 메시지가 없을 수 있습니다.
2. **타임존 불일치**: 데이터의 날짜와 선택한 시간 범위의 타임존이 다를 수 있습니다.
3. **날짜 형식 문제**: 일부 메시지의 날짜 형식이 표준 ISO 8601 형식이 아닐 수 있습니다.

### 해결 방법

#### 1. 기본 범위 사용 (가장 간단한 방법)
1. 애플리케이션을 재시작하면 기본적으로 **최근 30일** 범위가 설정됩니다.
2. 이 범위는 대부분의 오프라인 데이터를 포함하므로 "메시지 없음" 오류가 발생하지 않습니다.
3. 필요시 "최근 7일" 또는 다른 빠른 선택 버튼을 사용하여 범위를 조정할 수 있습니다.

#### 2. 시간 범위 확인
1. 데이터 파일의 실제 날짜 범위를 확인합니다:
   ```bash
   python test_actual_filtering.py
   ```
2. 출력된 "최소 날짜"와 "최대 날짜"를 확인합니다.
3. GUI에서 해당 범위 내의 시간을 선택합니다.

#### 3. 데이터 파일 확인
데이터 파일의 날짜 형식을 확인합니다:

**chat_communications.json:**
```json
{
  "rooms": {
    "dm:designer:dev": [
      {
        "id": 29,
        "sender": "designer",
        "body": "메시지 내용",
        "sent_at": "2025-10-16T18:18:06.955893Z"  ← 이 형식이어야 함
      }
    ]
  }
}
```

**email_communications.json:**
```json
{
  "mailboxes": {
    "pm.1@quickchat.dev": [
      {
        "id": 750,
        "sender": "designer.1@quickchat.dev",
        "subject": "제목",
        "body": "내용",
        "sent_at": "2025-11-05T01:15:06.955893Z"  ← 이 형식이어야 함
      }
    ]
  }
}
```

**지원되는 날짜 형식:**
- `2025-10-16T18:18:06.955893Z` (ISO 8601 with Z)
- `2025-10-16T18:18:06.955893+00:00` (ISO 8601 with timezone)
- `2025-10-16T18:18:06` (ISO 8601 without timezone, UTC로 간주됨)

#### 4. 로그 확인
로그 파일을 확인하여 실제 원인을 파악합니다:

1. `logs/` 디렉토리가 있는지 확인
2. 최신 로그 파일 열기
3. "시간 범위 필터링" 관련 로그 확인

로그 예시:
```
⏰ 시간 범위 필터링 시작: 2025-10-16T15:12:00+00:00 ~ 2025-10-17T15:12:00+00:00
🔍 첫 번째 chat 메시지 날짜: 2025-10-16T18:18:06.955893+00:00
🔍 첫 번째 email 메시지 날짜: 2025-11-05T01:15:06.955893+00:00
⏰ 시간 범위 필터링 완료: chat 753→108, email 1021→148
```

#### 5. 디버깅 모드 활성화
더 자세한 정보를 보려면 로깅 레벨을 DEBUG로 변경합니다:

**main.py 수정:**
```python
logging.basicConfig(
    level=logging.DEBUG,  # INFO에서 DEBUG로 변경
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

### 데이터 범위 확인 스크립트

프로젝트 루트에서 다음 명령을 실행하여 데이터의 실제 날짜 범위를 확인할 수 있습니다:

```bash
python test_actual_filtering.py
```

출력 예시:
```
================================================================================
시간 범위: 2025-10-16T15:12:00+00:00 ~ 2025-10-17T15:12:00+00:00
================================================================================

📱 Chat 메시지:
  전체: 753개
  범위 내: 108개
  최소 날짜: 2025-10-15T18:15:06.955893+00:00
  최대 날짜: 2025-11-05T00:51:06.955893+00:00

📧 Email 메시지:
  전체: 1021개
  범위 내: 148개
  최소 날짜: 2025-10-15T09:15:07+00:00
  최대 날짜: 2025-11-05T01:15:06.955893+00:00

📊 총합:
  전체: 1774개
  범위 내: 256개
```

### 추가 도움말

#### 시간 범위 선택 팁
- **기본 범위 (최근 30일)**: 애플리케이션 시작 시 자동 설정, 대부분의 데이터 포함
- **최근 1시간**: 현재 시간 기준 1시간 전부터 현재까지
- **최근 4시간**: 현재 시간 기준 4시간 전부터 현재까지
- **오늘**: 오늘 00:00 (UTC)부터 현재까지
- **어제**: 어제 00:00 (UTC)부터 오늘 00:00 (UTC)까지
- **최근 7일**: 7일 전 00:00 (UTC)부터 현재까지

#### 타임존 주의사항
- 모든 시간은 **UTC (협정 세계시)** 기준입니다.
- 한국 시간(KST)은 UTC+9이므로, UTC 시간에서 9시간을 더하면 한국 시간입니다.
- 예: UTC 15:12 = KST 00:12 (다음 날)

### 여전히 문제가 해결되지 않는 경우

1. **데이터 파일 재확인**: `data/mobile_4week_ko/` 디렉토리의 JSON 파일이 올바른 형식인지 확인
2. **캐시 삭제**: `data/mobile_4week_ko/todos_cache.db` 파일 삭제 후 재시작
3. **애플리케이션 재시작**: GUI를 완전히 종료하고 다시 시작
4. **로그 확인**: `logs/` 디렉토리의 최신 로그 파일 확인

### 관련 파일
- `main.py`: 메시지 수집 및 필터링 로직
- `utils/datetime_utils.py`: 날짜 파싱 유틸리티
- `ui/time_range_selector.py`: 시간 범위 선택 UI
- `test_actual_filtering.py`: 데이터 범위 확인 스크립트
